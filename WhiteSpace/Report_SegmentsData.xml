<script>
	<set var="dumpFile">C:\temp\SegmentFlatData.csv</set>
	<select from="crm" entity="vs360_rsdispersion" var="records">
        <attr name="vs360_matched" />
		<attr name="vs360_unmatched" />
		<attr name="vs360_matchedpercent" />
		<attr name="vs360_unmatchedpecent" />
		<join type="inner" entity="vs360_rsvalue" to="vs360_rsvalueid" from="vs360_rsvalueid">
            <attr name="vs360_name" as="value_name"/>
			<attr name="vs360_total" as="value_total"/>
			<join type="inner" entity="vs360_revenuesegment" to="vs360_revenuesegmentid" from="vs360_revenuesegmentid">
                <attr name="vs360_name" as="segment_name"/>
            </join>
        </join>
		<join type="inner" entity="vs360_revenueservice" to="vs360_revenueserviceid" from="vs360_revenueserviceid">
            <attr name="vs360_name" as="revenuservice_name"/>
        </join>
    </select>
	

	<set var="csvData">{new List()}</set>
	<for var="r" in="records">
		<set var="csvRow">{new Dictionary()}</set>
		<set var="csvRow['Segment']">{r.segment_name}</set>
		<set var="csvRow['Value']">{r.value_name}</set>
		<set var="csvRow['ValueTotal']">{r.value_total}</set>
		<set var="csvRow['RevenueService']">{r.revenuservice_name}</set>
		<set var="csvRow['Matched']">{r.vs360_matched}</set>
		<set var="csvRow['Matched%']">{r.vs360_matchedpercent}</set>
		<set var="csvRow['Unmatched']">{r.vs360_unmatched}</set>
		<set var="csvRow['Unmatched%']">{r.vs360_unmatchedpecent}</set>
		
		<set var="csvData[]">{csvRow}</set>
    </for>
	<set var="result">{Csv.Write(csvData, dumpFile, Encoding.UTF8, ',', '"','#',true,false)}</set>
</script>