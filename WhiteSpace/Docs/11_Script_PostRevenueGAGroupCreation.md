# Script: PostRevenueGAGroupCreation.xml

## Purpose

PostRevenueGAGroupCreation reads the CSV output from Report_PotentialGroups and automatically creates new Revenue Service records based on the recommended service groupings. This streamlines the process of creating new service groups after identifying natural service patterns.

**Key Characteristics**:
- **CSV-driven**: Reads Report_PotentialGroups output
- **Selective creation**: Only creates groups marked with `UseThisGroup = True`
- **Duplicate prevention**: Checks if Revenue Service already exists before creating
- **Batch processing**: Creates all recommended groups in one execution

---

## When to Use This Script

Run PostRevenueGAGroupCreation when:
- **After Report_PotentialGroups analysis**: You've reviewed the report and decided which groups to create
- **Creating new service groups**: Want to reorganize services based on purchase patterns
- **Bulk creation needed**: Multiple new service groups to create at once
- **After editing CSV**: You've marked desired groups as `UseThisGroup = True`

**Typical usage**: One-time after initial analysis, or when restructuring service groups

---

## What You Need Before Running

### Prerequisites
1. **Report_PotentialGroups executed**: CSV file must exist
2. **CSV reviewed and edited**: Marked desired groups as `UseThisGroup = True`
3. **CSV file accessible**: At the path specified in script

### Workflow Context
This script is part of a workflow:
```
1. Report_PotentialGroups → Generate CSV with potential groups
2. Review CSV → Decide which groups to create
3. Edit CSV → Mark UseThisGroup = True for desired groups
4. PostRevenueGAGroupCreation → Create the groups
5. RevenueServiceProcessing → Process with new groups
```

---

## What the Script Does

### Process Flow

```
1. Load existing Revenue Services (to check for duplicates)
2. Read CSV file from Report_PotentialGroups
3. For each row in CSV:
   - Check if UseThisGroup = "True"
   - If yes:
     - Parse NewRecords JSON
     - For each service in the JSON:
       - Check if Revenue Service already exists (by group + name)
       - If not exists: Create new Revenue Service record
4. Complete
```

### Detailed Operations

#### Phase 1: Load Existing Services
```xml
<select from="crm" entity="vs360_revenueservice" var="records">
    <where>
        <condition attr="statecode" op="eq">{0}</condition>
    </where>
    <attr name="vs360_name"/>
    <attr name="vs360_revenueserviceid"/>
    <attr name="vs360_selectedcombinations"/>
    <attr name="vs360_group" />
</select>
```

Creates a dictionary keyed by `group + name` to detect duplicates.

#### Phase 2: Read CSV
```xml
<set var="records">{Csv.Read(dumpFile, Encoding.UTF8, ',', '"')}</set>
```

Reads the CSV file generated by Report_PotentialGroups.

#### Phase 3: Process Rows
For each row where `UseThisGroup = "True"`:
- Extracts the `NewRecords` column (contains JSON array)
- Parses JSON to get array of service definitions
- Each service definition contains:
  - `vs360_name`: Service name with new group prefix
  - `vs360_selectedcombinations`: JSON query configuration
  - `vs360_group`: New group number

#### Phase 4: Create Services
For each service in the JSON array:
- Checks if service with same `group + name` already exists
- If not: Creates new Revenue Service record with all attributes

---

## Configuration

### Input File Path

```xml
<set var="dumpFile">C:\temp\dump.csv</set>
```

**Important**: This must match the output path from Report_PotentialGroups.

**To change path**:
```xml
<set var="dumpFile">D:\Reports\PotentialGroups.csv</set>
```

Ensure the CSV file exists at this location before running.

---

## Preparing the CSV File

### Step 1: Generate CSV
Run Report_PotentialGroups to create the initial CSV file.

### Step 2: Open in Excel
Open `C:\temp\dump.csv` in Excel.

### Step 3: Review Recommendations
The script automatically marks groups with 100+ companies as `UseThisGroup = TRUE`.

**Review each row**:
- **GroupCount**: How many companies have this combination?
- **Services**: What services are in this group?
- **ServicesCount**: How many services?

### Step 4: Edit UseThisGroup Column
Change values based on your business decision:

**Set to TRUE** when:
- Group makes business sense
- Sufficient company count
- You want separate analysis of this combination
- Services are related

**Set to FALSE** when:
- Group is too small or too large
- Services are unrelated
- Don't want this as a separate group
- Pattern seems temporary or coincidental

**Example editing**:
```csv
GroupCount,Services,ServicesCount,UseThisGroup,NewRecords
150,"Tax;Audit;Advisory",3,TRUE,"[...JSON...]"
45,"Tax;Consulting",2,FALSE,"[...JSON...]"
200,"Audit;Compliance",2,TRUE,"[...JSON...]"
```

In this example:
- First group: 150 companies, keep as TRUE
- Second group: Only 45 companies, changed to FALSE (won't create)
- Third group: 200 companies, keep as TRUE

### Step 5: Save CSV
Save the edited CSV file (ensure it remains UTF-8 encoded CSV format).

---

## Script Execution

### Running the Script

1. **Prepare**:
   - CSV file exists and is edited
   - Path in script matches CSV location
   - Reviewed which groups will be created

2. **Execute**:
   - Load PostRevenueGAGroupCreation.xml in Sync360
   - Run the script
   - Monitor for completion

3. **Verify**:
   - Check Revenue Service table in Dataverse
   - Confirm new services were created
   - Verify group numbers and names are correct

### Execution Time
Typically very fast:
- Depends on number of groups marked TRUE
- Usually <1 minute

---

## Expected Results

After successful execution:

### New Revenue Service Records Created

**Example** (for a group with Tax, Audit, Advisory):

| Name | Group | JSON Query | State |
|------|-------|------------|-------|
| (5) Tax Services | 5 | {original Tax query} | Active |
| (5) Audit Services | 5 | {original Audit query} | Active |
| (5) Advisory Services | 5 | {original Advisory query} | Active |

**Note**: Group number (5) is auto-assigned based on max existing group + 1

### Characteristics
- **Same queries**: JSON configurations are copied from original services
- **New group number**: Auto-incremented from current maximum
- **New names**: Include new group prefix "(5) Service Name"
- **Active state**: Ready for processing

---

## What Happens Next

### After Creating New Groups

1. **Review new services**:
   - Check Dataverse Revenue Service table
   - Verify names and groups are correct

2. **Run RevenueServiceProcessing**:
   - Process companies with new service groups
   - Create matched/unmatched relationships for new groups

3. **Analyze new groups**:
   - Run reports on new groups
   - Compare analysis with original groups
   - Validate that grouping provides better insights

4. **Decide on old services**:
   - Keep original services active, OR
   - Deactivate original services (if replaced by new groups)

---

## Important Considerations

### Duplicate Prevention
The script checks if a service with the same `group + name` already exists:
```xml
<if condition="!RevenueServicesNG.ContainsKey(j.vs360_group+j.vs360_name)">
    <!-- Create -->
</if>
```

**Safe to re-run**: If you accidentally run twice, duplicates won't be created.

### JSON Configuration Preservation
The script copies the original service's JSON query configuration:
```xml
<attr name="vs360_selectedcombinations">{j.vs360_selectedcombinations}</attr>
```

**Result**: New services have identical logic to originals, just in a different group.

### Group Number Assignment
Group numbers are auto-assigned by Report_PotentialGroups based on:
```xml
<set var="uniqueGRP">{maxGroup+1}</set>
```

Each new group combination gets a unique incrementing number.

---

## Advanced Usage

### Creating Partial Groups

If you only want some services from a combination:
1. Edit the `NewRecords` JSON in the CSV
2. Remove unwanted service objects from the array
3. Save and run script

**Example**:
Original JSON has 3 services [A, B, C]
Edit to keep only [A, B]
Script creates only A and B in new group

### Custom Group Numbers

If you want specific group numbers instead of auto-assigned:
1. Edit the CSV before running
2. In `NewRecords` JSON, change `vs360_group` values
3. Ensure numbers don't conflict with existing groups

### Merging Groups

To merge multiple service combinations into one group:
1. Edit CSV to give them the same `vs360_group` number
2. All will be created in the same group
3. Useful for consolidating related patterns

---

## Troubleshooting

### Issue: No services created
**Possible causes**:
- No rows have `UseThisGroup = True`
- CSV file path incorrect
- CSV file not found
- All services already exist (duplicates)

**Debug**:
1. Verify CSV path matches script
2. Open CSV and check `UseThisGroup` column
3. Check script logs for errors
4. Manually verify file exists

### Issue: Some services created, others not
**Expected behavior**: If service already exists, script skips it
- Check if some services in the group were previously created
- Review Dataverse for existing services with same group+name

### Issue: JSON parsing error
**Causes**:
- CSV corrupted or improperly formatted
- NewRecords column has invalid JSON
- Excel changed formatting when saving

**Solutions**:
- Re-export CSV from Report_PotentialGroups
- Ensure CSV saved as UTF-8
- Validate JSON in NewRecords column

### Issue: Wrong group numbers
**Check**:
- Report_PotentialGroups calculated correct max group
- CSV wasn't edited to change group numbers inadvertently
- No other services created between report and this script

---

## Best Practices

1. **Review carefully**: Don't blindly create all recommended groups
2. **Start conservative**: Create 1-2 groups initially, validate, then expand
3. **Test in dev first**: If possible, test in development environment
4. **Backup CSV**: Keep original CSV before editing
5. **Document decisions**: Note why certain groups were/weren't created
6. **Verify before processing**: Check created services before running RevenueServiceProcessing

---

## Example Workflow

### Complete Group Creation Workflow

**Step 1: Generate potential groups**
```
Run: Report_PotentialGroups.xml
Output: C:\temp\dump.csv
```

**Step 2: Analyze results**
```
Open: C:\temp\dump.csv in Excel
Review: GroupCount, Services, ServicesCount
Identify: Meaningful service combinations
```

**Step 3: Make decisions**
```
Group A (150 companies, Tax+Audit+Advisory): UseThisGroup = TRUE
Group B (45 companies, Tax+Consulting): UseThisGroup = FALSE
Group C (200 companies, Consulting+Compliance): UseThisGroup = TRUE
```

**Step 4: Save edited CSV**
```
Save: C:\temp\dump.csv
Verify: File saved properly
```

**Step 5: Create groups**
```
Run: PostRevenueGAGroupCreation.xml
Verify: Check Dataverse for new Revenue Services
Result: Group 5 (Tax+Audit+Advisory), Group 6 (Consulting+Compliance) created
```

**Step 6: Process new groups**
```
Run: RevenueServiceProcessing.xml
Result: Companies classified with new groups
```

**Step 7: Analyze new groups**
```
Run: Report_ServicesMatrix.xml (view correlations within new groups)
Run: Report_SegmentsData.xml (segment analysis for new groups)
```

---

## Integration with Overall Workflow

### Position in Implementation

```
Phase 1: Initial Setup
- GenerateRevenueService (all services in one group)
- RevenueServiceProcessing

Phase 2: Analysis
- Report_PotentialGroups → Identify natural groupings
- Report_ServicesMatrix → See correlations

Phase 3: Optimization
- PostRevenueGAGroupCreation → Create optimized groups
- RevenueServiceProcessing → Reprocess with new groups

Phase 4: Ongoing
- Schedule RevenueServiceProcessing
- Periodic analysis with new groups
```

---

**Next**: After creating new groups, run RevenueServiceProcessing to process companies with the new structure, then re-run analytics reports to validate improvements.
