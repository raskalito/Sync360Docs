# Script: PostRevenueGAGroupCreation.xml

## Purpose

PostRevenueGAGroupCreation reads the CSV output from Report_PotentialGroups and automatically creates new Revenue Service records based on the recommended service groupings, streamlining the process of creating new service groups after identifying natural service patterns. This CSV-driven automation selectively creates only groups marked with `UseThisGroup = True`, includes duplicate prevention to check if Revenue Services already exist before creating them, and supports batch processing to create all recommended groups in a single execution.


## When to Use This Script

Run PostRevenueGAGroupCreation after completing your Report_PotentialGroups analysis and deciding which groups merit creation. Use this script when you want to reorganize services based on purchase patterns discovered in the data, especially when bulk creation is needed for multiple new service groups at once. The script should be executed after you've edited the CSV file to mark desired groups as `UseThisGroup = True`, ensuring only your approved groups are created. This is typically a one-time operation after initial analysis, or when restructuring service groups based on evolved business needs or customer patterns.


## What You Need Before Running

### Prerequisites
1. **Report_PotentialGroups executed**: CSV file must exist
2. **CSV reviewed and edited**: Marked desired groups as `UseThisGroup = True`
3. **CSV file accessible**: At the path specified in script

### Workflow Context
This script is part of a workflow:
```
1. Report_PotentialGroups → Generate CSV with potential groups
2. Review CSV → Decide which groups to create
3. Edit CSV → Mark UseThisGroup = True for desired groups
4. PostRevenueGAGroupCreation → Create the groups
5. RevenueServiceProcessing → Process with new groups
```


## What the Script Does

### Process Flow

```
1. Load existing Revenue Services (to check for duplicates)
2. Read CSV file from Report_PotentialGroups
3. For each row in CSV:
   - Check if UseThisGroup = "True"
   - If yes:
     - Parse NewRecords JSON
     - For each service in the JSON:
       - Check if Revenue Service already exists (by group + name)
       - If not exists: Create new Revenue Service record
4. Complete
```

### Detailed Operations

#### Phase 1: Load Existing Services

The script begins by querying all active Revenue Services from Dataverse, retrieving their name, ID, JSON configuration, and group number. It creates a dictionary keyed by the combination of group number and service name to enable efficient duplicate detection during the creation phase.

#### Phase 2: Read CSV

The script reads the CSV file generated by Report_PotentialGroups using UTF-8 encoding to ensure proper character handling. This CSV contains all the recommendations about which service combinations should become new groups.

#### Phase 3: Process Rows

For each row where `UseThisGroup = "True"`, the script extracts the `NewRecords` column which contains a JSON array of service definitions. It parses this JSON to get the array of services, with each service definition containing the service name (with new group prefix), the JSON query configuration, and the new group number.

#### Phase 4: Create Services

For each service in the JSON array, the script checks whether a service with the same group number and name combination already exists in the dictionary built in Phase 1. If the service doesn't exist, it creates a new Revenue Service record with all the specified attributes, preserving the original query logic while assigning it to the new group.


## Configuration

### Input File Path

```xml
<set var="dumpFile">C:\temp\dump.csv</set>
```

**Important**: This must match the output path from Report_PotentialGroups.

**To change path**:
```xml
<set var="dumpFile">D:\Reports\PotentialGroups.csv</set>
```

Ensure the CSV file exists at this location before running.


## Preparing the CSV File

### Step 1: Generate CSV
Run Report_PotentialGroups to create the initial CSV file.

### Step 2: Open in Excel
Open `C:\temp\dump.csv` in Excel.

### Step 3: Review Recommendations
The script automatically marks groups with 100+ companies as `UseThisGroup = TRUE`.

**Review each row**:
- **GroupCount**: How many companies have this combination?
- **Services**: What services are in this group?
- **ServicesCount**: How many services?

### Step 4: Edit UseThisGroup Column
Change values based on your business decision:

**Set to TRUE** when:
- Group makes business sense
- Sufficient company count
- You want separate analysis of this combination
- Services are related

**Set to FALSE** when:
- Group is too small or too large
- Services are unrelated
- Don't want this as a separate group
- Pattern seems temporary or coincidental

**Example editing**:
```csv
GroupCount,Services,ServicesCount,UseThisGroup,NewRecords
150,"Tax;Audit;Advisory",3,TRUE,"[...JSON...]"
45,"Tax;Consulting",2,FALSE,"[...JSON...]"
200,"Audit;Compliance",2,TRUE,"[...JSON...]"
```

In this example:
- First group: 150 companies, keep as TRUE
- Second group: Only 45 companies, changed to FALSE (won't create)
- Third group: 200 companies, keep as TRUE

### Step 5: Save CSV
Save the edited CSV file (ensure it remains UTF-8 encoded CSV format).


## Script Execution

### Running the Script

1. **Prepare**:
   - CSV file exists and is edited
   - Path in script matches CSV location
   - Reviewed which groups will be created

2. **Execute**:
   - Load PostRevenueGAGroupCreation.xml in Sync360
   - Run the script
   - Monitor for completion

3. **Verify**:
   - Check Revenue Service table in Dataverse
   - Confirm new services were created
   - Verify group numbers and names are correct

### Execution Time
Typically very fast:
- Depends on number of groups marked TRUE
- Usually <1 minute


## Expected Results

After successful execution, new Revenue Service records are created based on your selections. For example, a group containing Tax, Audit, and Advisory services would result in three new Revenue Service records: "(5) Tax Services", "(5) Audit Services", and "(5) Advisory Services", all assigned to group 5. The group number 5 is auto-assigned based on the maximum existing group plus one. These new services have the same JSON query configurations as the original services, just assigned to the new group number. Their names include the new group prefix, and they're created in an active state ready for processing.

### Characteristics
- **Same queries**: JSON configurations are copied from original services
- **New group number**: Auto-incremented from current maximum
- **New names**: Include new group prefix "(5) Service Name"
- **Active state**: Ready for processing


## What Happens Next

After creating new groups, review the new services by checking the Dataverse Revenue Service table to verify names and groups are correct. Run RevenueServiceProcessing to process companies with the new service groups, which creates matched and unmatched relationships for the new groups. Analyze the new groups by running reports to compare analysis with original groups and validate that the new grouping provides better insights. Finally, decide on the old services - either keep the original services active alongside the new groups, or deactivate the original services if they've been replaced by the new groups.


## Important Considerations

### Duplicate Prevention

The script checks if a service with the same group and name combination already exists before creating it, making it safe to re-run. If you accidentally execute the script twice, duplicates won't be created, and the script will simply skip services that already exist.

### JSON Configuration Preservation

The script copies the original service's JSON query configuration to the new services, ensuring that new services have identical logic to the originals, just assigned to a different group. This means the service criteria remain the same while the organizational structure changes to reflect the discovered patterns.

### Group Number Assignment

Group numbers are auto-assigned by Report_PotentialGroups based on the maximum existing group number plus one. Each new group combination gets a unique incrementing number, ensuring no conflicts with existing groups.


## Advanced Usage

### Creating Partial Groups

If you only want some services from a combination, you can edit the `NewRecords` JSON in the CSV to remove unwanted service objects from the array. For example, if the original JSON contains three services [A, B, C] but you only want [A, B], edit the JSON to remove C. When you save and run the script, it creates only A and B in the new group.

### Custom Group Numbers

If you want specific group numbers instead of auto-assigned values, edit the CSV before running the script. In the `NewRecords` JSON, change the `vs360_group` values to your desired numbers, ensuring they don't conflict with existing groups to avoid confusion.

### Merging Groups

To merge multiple service combinations into one group, edit the CSV to give them the same `vs360_group` number. All services will be created in the same group, which is useful for consolidating related patterns that you want analyzed together.


## Troubleshooting

### Issue: No services created
**Possible causes**:
- No rows have `UseThisGroup = True`
- CSV file path incorrect
- CSV file not found
- All services already exist (duplicates)

**Debug**:
1. Verify CSV path matches script
2. Open CSV and check `UseThisGroup` column
3. Check script logs for errors
4. Manually verify file exists

### Issue: Some services created, others not
**Expected behavior**: If service already exists, script skips it
- Check if some services in the group were previously created
- Review Dataverse for existing services with same group+name

### Issue: JSON parsing error
**Causes**:
- CSV corrupted or improperly formatted
- NewRecords column has invalid JSON
- Excel changed formatting when saving

**Solutions**:
- Re-export CSV from Report_PotentialGroups
- Ensure CSV saved as UTF-8
- Validate JSON in NewRecords column

### Issue: Wrong group numbers
**Check**:
- Report_PotentialGroups calculated correct max group
- CSV wasn't edited to change group numbers inadvertently
- No other services created between report and this script


## Best Practices

1. **Review carefully**: Don't blindly create all recommended groups
2. **Start conservative**: Create 1-2 groups initially, validate, then expand
3. **Test in dev first**: If possible, test in development environment
4. **Backup CSV**: Keep original CSV before editing
5. **Document decisions**: Note why certain groups were/weren't created
6. **Verify before processing**: Check created services before running RevenueServiceProcessing


## Example Workflow

### Complete Group Creation Workflow

The complete workflow begins by running Report_PotentialGroups.xml which outputs to C:\temp\dump.csv. Open this CSV in Excel and analyze the results, reviewing GroupCount, Services, and ServicesCount to identify meaningful service combinations. Make decisions about which groups to create - for example, marking Group A (150 companies, Tax+Audit+Advisory) as UseThisGroup = TRUE, Group B (45 companies, Tax+Consulting) as FALSE due to low count, and Group C (200 companies, Consulting+Compliance) as TRUE. Save the edited CSV and verify it saved properly. Run PostRevenueGAGroupCreation.xml and verify in Dataverse that new Revenue Services were created, resulting in Group 5 for Tax+Audit+Advisory and Group 6 for Consulting+Compliance. Process the new groups by running RevenueServiceProcessing.xml to classify companies with the new groups. Finally, analyze the new groups by running Report_ServicesMatrix.xml to view correlations within new groups and Report_SegmentsData.xml for segment analysis on the new groups.


## Integration with Overall Workflow

The script fits into the broader implementation in a specific sequence. Phase 1 (Initial Setup) involves running GenerateRevenueService with all services in one group, then RevenueServiceProcessing. Phase 2 (Analysis) runs Report_PotentialGroups to identify natural groupings and Report_ServicesMatrix to see correlations. Phase 3 (Optimization) executes PostRevenueGAGroupCreation to create optimized groups, then RevenueServiceProcessing to reprocess with the new group structure. Phase 4 (Ongoing) involves scheduling RevenueServiceProcessing regularly and performing periodic analysis using the refined group structure.
