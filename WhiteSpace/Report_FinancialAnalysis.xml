<script>
	<set var="dumpFile">C:\temp\dump.csv</set>
	<select from="crm" entity="vs360_revenueservice" var="records">
		<where>
			<condition attr="statecode" op="eq">{0}</condition>
		</where>
		<attr name="vs360_name"/>
		<attr name="vs360_revenueserviceid"/>
		<attr name="vs360_selectedcombinations"/>
		<attr name="vs360_group" />
	</select>
	<set var="RevenueServices">{new Dictionary()}</set>
	<set var="RevenueServicesToPractice">{new Dictionary()}</set>
	<set var="PracticeToRevenueServices">{new Dictionary()}</set>
	<set var="maxGroup">{0}</set>
	<for var="r" in="records">
		<set var="rid">{r.vs360_revenueserviceid.ToString()}</set>
		<set var="RevenueServices[rid]">{r}</set>
		<set var="maxGroup" if="maxGroup lt (r.vs360_group as 'int')">{r.vs360_group as 'int'}</set>
		<set var="json">{null}</set>
		<sandbox verbose="false">
			<set var="json">{Json.GetDictionary(r.vs360_selectedcombinations)}</set>
		</sandbox>
		<if condition="json.isSet">
			<set var="practiceId">{null}</set>
			<for var="rule" in="json.rules">
				<for var="cond" in="rule.conditions">
					<if condition="cond._and.isSet">
						<for var="grp" in="cond._and">
							<if condition="grp.attr eq 'vs360_practiceareaid'">
                                <set var="practiceId">{grp.value}</set>
                            </if>
						</for>
					</if>
					<if condition="cond._or.isSet">
						<for var="grp" in="cond._or">
							<if condition="grp.attr eq 'vs360_practiceareaid'">
                                <set var="practiceId">{grp.value}</set>
                            </if>
						</for>
					</if>
                </for>
			</for>
			<if condition="practiceId.isSet">
                <set var="RevenueServicesToPractice[rid]">{practiceId}</set>
				<set var="PracticeToRevenueServices[practiceId]">{rid}</set>
            </if>
		</if>
	</for>
	<select from="crm" entity="vs360_account_vs360_revenueservice_matched" var="records">
		<attr name="accountid"/>
		<attr name="vs360_revenueserviceid"/>
		<order by="vs360_revenueserviceid" />
	</select>
	<set var="dictGrouping">{new Dictionary()}</set>
	<for var="r" in="records">
        <set var="aid">{r.accountid.ToString()}</set>
		<set var="rid">{r.vs360_revenueserviceid.ToString()}</set>
		<set var="dictGrouping[aid]" if="!dictGrouping.ContainsKey(aid)">{new Dictionary()}</set>
		<set var="dictGrouping[aid][rid]">{null}</set>
    </for>
	<set var="nowGroups">{new Dictionary()}</set>
	<for var="aid" in="dictGrouping.Keys">
		<set var="key"></set>
		<if condition="dictGrouping[aid].Count gt 1">
			<for var="rid" in="dictGrouping[aid]">
				<set var="key">{key}{rid}</set>
			</for>
			<select from="crm" entity="vs360_job" var="matters">
                <where>
                    <condition attr="vs360_accountid" op="eq">{aid}</condition>
					<or>
						<for var="rid" in="dictGrouping[aid].Keys">
							<condition attr="vs360_practiceareaid" op="eq">{RevenueServicesToPractice[rid]}</condition>
						</for>
					</or>
                </where>
                <attr name="vs360_practiceareaid"/>
				<attr name="fol_fb5ytotal" />
            </select>
            <for var="m" in="matters">
                <set var="nowGroups[key]" if="!nowGroups.ContainsKey(key)">{new Dictionary()}</set>
				<set var="nowGroups[key][aid]" if="!nowGroups[key].ContainsKey(aid)">{new Dictionary()}</set>
				<set var="rid">{PracticeToRevenueServices[m.vs360_practiceareaid.Id.ToString()]}</set>
				<set var="nowGroups[key][aid][rid]" if="!nowGroups[key][aid].ContainsKey(rid)">{0}</set>
				<set var="nowGroups[key][aid][rid]" if="m.fol_fb5ytotal.isSet">{nowGroups[key][aid][rid] + m.fol_fb5ytotal}</set>
            </for>
        </if>
		
    </for>
	
	<set var="csvData">{new List()}</set>

	<for var="key" in="nowGroups.Keys">
		<set var="dict">{new Dictionary()}</set>
		<for var="aid" in="nowGroups[key].Keys">
			<for var="rid" in="nowGroups[key][aid].Keys">
				<set var="dict[rid]" if="!dict.ContainsKey(rid)">{0}</set>
				<set var="dict[rid]">{dict[rid] + nowGroups[key][aid][rid]}</set>
			</for>
		</for>
		<set var="groupTotal">{0}</set>
		<for var="rid" in="dict.Keys">
            <set var="groupTotal">{groupTotal + dict[rid]}</set>
        </for>
		<for var="aid" in="nowGroups[key].Keys">
            <set var="services"></set>
			<set var="Total">{0}</set>
			<for var="rid" in="nowGroups[key][aid].Keys">
				<set var="services">{services}{RevenueServices[rid].vs360_name};</set>
				<set var="Total">{Total+nowGroups[key][aid][rid]}</set>
			</for>
       
			<for var="rid" in="nowGroups[key][aid].Keys">
				<set var="csvRow">{new Dictionary()}</set>
				<set var="csvRow['ServiceGroup']">{services}</set>
				<set var="csvRow['GroupTotalFinancial']">{groupTotal}</set>
				<set var="csvRow['GroupServiceFinancial']">{dict[rid]}</set>
				<set var="csvRow['Company']">{aid}</set>
				<set var="csvRow['Service']">{RevenueServices[rid].vs360_name}</set>
				<set var="csvRow['FinancialValue']">{nowGroups[key][aid][rid]}</set>
				<set var="csvRow['FinancialPercentage']">{nowGroups[key][aid][rid]/Total}</set>
				<set var="csvRow['FinancialCompanyTotal']">{Total}</set>
				<set var="csvData[]">{csvRow}</set>
			</for>
		</for>
    </for>
	<set var="result">{Csv.Write(csvData, dumpFile, Encoding.UTF8, ',', '"','#',true,false)}</set>
</script>